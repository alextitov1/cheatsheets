
# Podman/Docker OCI

## Get Help

podman --help

man podman-run # sudo mandb

## Basic commands

```sh
podman ps
podman images
podman logs <ContainerId>

podman image inspect <ImageId>
podman exec -it <ContainerId> sh

podman stop $(podman ps -aq)
podman rm $(podman ps -aq)

podman inspect --format='{{.State.Running}}' httpd

# Podman sends a SIGTERM signal to stop the container gracefully, but the application ignores the signal. After 5 seconds, Podman sends a SIGKILL signal to the container. The --time flag indicates the time that Podman waits before sending a SIGKILL signal to forcefully stop the container.
podman stop greeter --time=5



```

## Network

```sh
podman network --help
```

### Basic command

```sh
podman network create example-net
podman run -d --name my-container --net example-net container-image:latest

podman network ls
podman network inspect <NetworkId>
podman port <ContainerId>

# When you create new containers, you can connect them to multiple networks by specifying network names in a comma-separated list
podman run -d --name double-connector --net postgres-net,redis-net container-image:latest


# Alternatively, if the my-container container is already running, then run the following command to connect it to the example-net network

podman network connect example-net my-container
```

### DNS

DNS is disabled in the default podman network. To enable DNS resolution between containers, create a Podman network and connect your containers to that network.


### Port-Forwarding

```sh
podman run -p 8075:80 my-app
podman run -p 127.0.0.1:8075:80 my-app
podman port my-app
podman port --all

podman inspect my-app -f '{{.NetworkSettings.Networks.apps.IPAddress}}'
```

## Storage

### path
```sh
ls -l /home/ricardo/.local/share/containers/storage/overlay-images/
```

#### diff
display the changes made to a container's filesystem since it was started

```sh
podman diff elastic_maxwell
```

#### cp
copy files/folders between a container and the local filesystem

```sh
podman cp index.html elastic_maxwell:/var/wwww/index.html
```



## Container Registry

### RedHat registries

```sh
registry.access.redhat.com # requires no authentication
registry.redhat.io # requires authentication
```

#### useful images

```sh
registry.access.redhat.com/ubi9 # RedHat Universal Base Image
registry.access.redhat.com/ubi9/python-39 # Python 3.9 on UBI9
```

### podman registry config

podman registries config file
`/etc/containers/registries.conf`

```sh
grep ^[^#] /etc/containers/registries.conf
``` 

### podman registry operation

#### search

```sh
podman search nginx
```

#### login

```sh
podman login registry.redhat.io
```

Podman stores the credentials in the ${XDG_RUNTIME_DIR}/containers/auth.json file
```
[user@host ~]$ cat ${XDG_RUNTIME_DIR}/containers/auth.json
{
	"auths": {
		"registry.redhat.io": {
			"auth": "dXNlcjpodW50ZXIy"
		}
	}
}
[user@host ~]$ echo -n dXNlcjpodW50ZXIy | base64 -d
user:hunter2
```

### quay

Quay.io - redhat public registry

container registry - local instance
```
 registry.redhat.io/quay/quay-rhel8
```

### utility

`scopeo` is a command line utility that allows you to inspect and manage container images.

```sh
skopeo copy --dest-tls-verify=false \
  docker://${RHOCP_REGISTRY}/default/python:3.9-ubi8 \
  docker://registry.ocp4.example.com:8443/developer/python:3.9-ubi8
```


# Dockerfile/Containerfile

## BaseImage
UBI - universal base images

* **Standard**: This is the primary UBI, which includes DNF, systemd, and utilities such as gzip and tar.

* **Init**: Simplifies running multiple applications within a single container by managing them with systemd.

* **Minimal**: This image is smaller than the init image and still provides nice-to-have features. This image uses the microdnf minimal package manager instead of the full-sized version of DNF.

* **Micro**: This is the smallest available UBI because it only includes the bare minimum number of packages. For example, this image does not include a package manager.

## Containerfile Instructions

Containerfiles use a small domain-specific language (DSL)

* FROM 

* WORKDIR

* COPY and ADD
> The ADD instruction adds the following functionality: 
> * Copying files from URLs.
> * Unpacking tar archives in the destination image.

> Because the ADD instruction adds functionality that might not be obvious, developers tend to prefer the COPY instruction for copying local files into the container image.

* RUN (Runs a command in the container)

* ENTRYPOINT (Sets the executable to run when the container is started) 

* CMD

Runs a command when the container is started. This command is passed to the executable defined by ENTRYPOINT. Base images define a default ENTRYPOINT, which is usually a shell executable, such as Bash.

> Neither ENTRYPOINT nor CMD run when building a container image. Podman executes them when you start a container from the image.

* USER (Instructions that follow the USER instruction run as this user, including the CMD instruction.)

* LABEL (Adds a key-value pair to the metadata of the image for organization and image selection)

* EXPOSE (This instruction does not bind the port on the host and is for documentation purposes)

* ENV (You can declare multiple ENV instructions within the Containerfile)

* ARG (Defines build-time variables, typically to make a customizable container build)

* VOLUME (Defines where to store data outside of the container)


# Utility

```sh
getent hosts <hostname>

```