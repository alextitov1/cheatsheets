# ex294 exam notes

## Ansible CLI

### ad hoc ansible commands

```sh

```sh
ansible -i inventory localhost -m setup
ansible-navigator run -m stdout site.yml --syntax-check

# default module is command -a argument localhost is the host
ansible -a /bin/date localhost 

# ansible_facts 
ansible -m setup localhost

# -k prompt for password
ansible -m ping -i inventory all -u 4esnok -k
```

### checks

```sh
ansible-playbook -i inventory site.yml --syntax-check
ansible-playbook -i inventory site.yml --check
```



### doc

```sh
ansible-doc -l
ansible-doc -s ansible.builtin.copy
ansible-navigator doc -t lookup -m lookup -l -m stdout 
```

### inventory

```sh
ansible-navigator inventory -m stdout --list
ansible-inventory --list
ansible-inventory --graph all
```

### vault

```sh
ansible-vault create secret.yml
ansible-vault create --vault-password-file=vault-pass secret.yml

ansible-vault view secret1.yml
ansible-vault edit secret.yml

ansible-vault encrypt secret1.yml secret2.yml
ansible-vault decrypt secret1.yml --output=secret1-decrypted.yml

ansible-vault rekey secret.yml
```

```sh
# prompt for the vault password
ansible-navigator run -m stdout --playbook-artifact-enable false create_users.yml --vault-id @prompt

ansible-navigator run -m stdout create_users.yml --vault-password-file=vault-pass
```

### galaxy

```sh
ansible-galaxy collection install fedora.linux_system_roles -p ./collections
```

## config path

* /etc/ansible/ansible.cfg # system wide
* ~/.ansible.cfg # home directory
* ./ansible.cfg # current directory

### ansible.cfg example

```ini
[defaults]
inventory = ./inventory
remote_user = root
host_key_checking = False
retry_files_enabled = False
roles_path = ./roles
library = ./library
module_utils = ./module_utils
callback_whitelist = profile_tasks
[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
```

### ansible-config

show configurations that have changed from the default

```sh
ansible-config dump --only-changed
```

generate ansible.cfg from a template

```sh
ansible-config init
```

## Syntax

### Conditionals

```yaml
---
- name: Simple Boolean Task Demo
  hosts: all
  vars:
    run_my_task: true
  tasks:
    - name: httpd package is installed
      ansible.builtin.dnf:
        name: httpd
      when: run_my_task | bool
```

```yaml
---
- name: Test Variable is Defined Demo
  hosts: all
  vars:
    my_service: httpd
  tasks:
    - name: "{{ my_service }} package is installed"
      ansible.builtin.dnf:
        name: "{{ my_service }}"
      when: my_service is defined
```

greater-thn character (>) used to split the long conditionals over multiple lines

```yaml
when: >
    ( ansible_facts['distribution'] == "RedHat" and
      ansible_facts['distribution_major_version'] == "9" )
    or
    ( ansible_facts['distribution'] == "Fedora" and
    ansible_facts['distribution_major_version'] == "34" )
```

these two conditions are equal

```yaml
when: ansible_facts['distribution_version'] == "9.0" and ansible_facts['kernel'] == "5.14.0-70.13.1.el9_0.x86_64"
```

```yaml
when:
  - ansible_facts['distribution_version'] == "9.0"
  - ansible_facts['kernel'] == "5.14.0-70.13.1.el9_0.x86_64"
```

### When examples

```yaml
when: ansible_facts['distribution'] == "RedHat"

#### When help

```sh
ansible-doc -s ansible.builtin.when
```

### Loops

```yaml
- name: Postfix and Dovecot are running
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
  loop:
    - postfix
    - dovecot
```

```yaml
- name: Users exist and are in the correct groups
  user:
    name: "{{ item['name'] }}"
    state: present
    groups: "{{ item['groups'] }}"
  loop:
    - name: jane
      groups: wheel
    - name: joe
      groups: root
```

```yaml
vars:
  mail_services:
    - postfix
    - dovecot
tasks:
  - name: Postfix and Dovecot are running
    ansible.builtin.service:
      name: "{{ item }}"
      state: started
    loop: "{{ mail_services }}"
```

The **register** keyword can also capture the output of a task that loops. The following snippet shows the structure of the **register** variable from a task that loops:

```yaml
---
- name: Loop Register Test
  gather_facts: no
  hosts: localhost
  tasks:
    - name: Looping Echo Task
      ansible.builtin.shell: "echo This is my item: {{ item }}"
      loop:
        - one
        - two
      register: echo_results
    - name: Show echo_results variable
      ansible.builtin.debug:
        var: echo_results
```

<details>
<summary>playbook output</summary>

```json
{"echo_results": {
        "changed": true,
        "msg": "All items completed",
        "results": [
            {
                "ansible_facts": {
                    "discovered_interpreter_python": "/usr/local/bin/python3.11"
                },
                "ansible_loop_var": "item",
                "changed": true,
                "cmd": "echo This is my item: one",
                "delta": "0:00:00.014493",
                "end": "2023-03-22 22:14:19.949881",
                "failed": false,
                "invocation": {}}]}}
```
</details>

#### Earlier-style Ansible loops

| Loop keyword | Description |
|---|---|
| `with_items`    | Behaves the same as the loop keyword for simple lists, such as a list of strings or a list of dictionaries. Unlike loop, if lists of lists are provided to with_items, they are flattened into a single-level list. The item loop variable holds the list item used during each iteration.|
| `with_file`     | Requires a list of control node file names. The item loop variable holds the content of a corresponding file from the file list during each iteration. |
| `with_sequence` | Requires parameters to generate a list of values based on a numeric sequence. The item loop variable holds the value of one of the generated items in the generated sequence during each iteration.|

#### Loop help

>Loops are facilitated by lookup plugin

```sh
ansible-doc -t lookup -l
ansible-doc -t keyword loop
```

### Handlers and Failure

```yaml
tasks:
  - name: copy demo.example.conf configuration template
    ansible.builtin.template:
      src: /var/lib/templates/demo.example.conf.template
      dest: /etc/httpd/conf.d/demo.example.conf
    notify:
      - restart apache
handlers:
  - name: restart apache
    ansible.builtin.service:
      name: httpd
      state: restarted
```

ignore_errors

```yaml
- name: Install {{ web_package }} package
  ansible.builtin.dnf:
    name: "{{ web_package }}"
    state: present
  ignore_errors: yes
```

change_when - change the status of the task

```yaml
- name: Check local time
  ansible.builtin.command: date
  register: command_result
  changed_when: false
```

failed_when - define what “failure” means in the task

```yaml
- name: Fail task when the command error output prints FAILED
  ansible.builtin.command: /usr/bin/example-command -x -y -z
  register: command_result
  failed_when: "'FAILED' in command_result.stderr"
```

### Block

block - a way to group tasks together and execute them as a single unit

```yaml
tasks:
  - name: Attempt to set up a webserver
    block:
      - name: Install {{ web_package }} package
        ansible.builtin.dnf:
          name: "{{ web_package }}"
          state: present
    rescue:
      - name: Install {{ db_package }} package
        ansible.builtin.dnf:
          name: "{{ db_package }}"
          state: present
    always:
      - name: Start {{ db_service }} service
        ansible.builtin.service:
          name: "{{ db_service }}"
          state: started
```

### Filters

#### Filter help

```sh
ansible-doc -t filter -l
```

#### Filter default and password_hash

```yaml
password: "{{ my_password | default('redhat') | password_hash('sha512') }}"
```

#### Filter dict2items

```yaml
vars:
  my_users:
    fred:
      groups:
        - flintstones
        - wheel
      password: yabadabadoo
    wilma:
      groups: flintstones
      password: yabadabadoo
    barney:
      groups: rubbles
      password: flimflom
tasks:
  - name: Ensure users are in their appropriate groups
    loop: "{{ my_users | dict2items }}"
    ansible.builtin.user:
      name: "{{ item['key'] }}"
      state: present
      groups: "{{ item['value']['groups'] }}"
      password: "{{ item['value']['password'] | password_hash('sha512') }}"
      update_password: on_create
      generate_ssh_key: yes
```

### Filter product and list

```yaml
vars:
  beatles:
    - John
    - Paul
    - George
    - Ringo
  
  category_db:
    - lyric
    - concerts
    - instruments

tasks:
  - name: Ensure Beatles access to their databases
    loop: "{{ beatles | product(category_db) | list }}"
    ansible.mysql.mysql_user:
      name: "{{ item[0] }}"
      priv: "{{ item[1] }}.*:ALL"
      append_privs: yes
      password: "{{ 'db_pass' | password_hash('sha512') }}"
```
> The **list** filter is used here to convert the result of the product filter into a list, which is then used to loop over.

## Variables and Facts

### Variables

<details>
<summary>Variables priority from top to bottom</summary>

* Group variables defined in the inventory
* Group variables defined in files in a group_vars subdirectory in the same directory as the inventory or the playbook
* Host variables defined in the inventory
* Host variables defined in files in a host_vars subdirectory in the same directory as the inventory or the playbook
* Host facts, discovered at runtime
* Play variables in the playbook (vars and vars_files)
* Task variables
* Extra variables defined on the command line
</details>

#### Inventory variables

You can define variables for hosts and host groups by creating two directories, _group_vars_ and _host_vars_, in the same working directory as the inventory file or playbook.

```sh
project
├── ansible.cfg
├── group_vars
│   ├── datacenters
│   ├── datacenters1
│   └── datacenters2
├── host_vars
│   ├── demo1.example.com
│   ├── demo2.example.com
│   ├── demo3.example.com
│   └── demo4.example.com
├── inventory
└── playbook.yml
```

#### Command line variables
set a variable on the command line

```sh
ansible-navigator run main.yml -e "package=apache"
```

#### Playbook variables
define a variable in a playbook or vars_files

```yaml
user1_first_name: Bob
user1_last_name: Jones
user1_home_dir: /users/bjones
user2_first_name: Anne
user2_last_name: Cook
user2_home_dir: /users/acook

users:
  bjones:
    first_name: Bob
    last_name: Jones
    home_dir: /users/bjones
  acook:
    first_name: Anne
    last_name: Cook
    home_dir: /users/acook
```

#### Var files

```yaml
- hosts: all
  vars_files:
    - vars/users.yml
```

### Work with dictionaries

```sh
# Ansible way
# Returns 'Bob'
users.bjones.first_name
# Returns '/users/acook'
users.acook.home_dir

# Python way
# Returns 'Bob'
users['bjones']['first_name']
# Returns '/users/acook'
users['acook']['home_dir']
```

### [Magic Variables](https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html)

#### Hostvars 
A dictionary with all the hosts in inventory and variables assigned to them

```sh
hostvars['demo2.example.com']['ansible_facts']['interfaces']
```

#### group_names
A list of groups the current host is part of

#### groups
A dictionary with all the groups in inventory and each group has the list of hosts that belong to it

#### inventory_hostname
The inventory name for the ‘current’ host being iterated over in the play

### Facts

```yaml
# Display all facts
- name: Fact dump
  hosts: all
  tasks:
    - name: Print all facts
      ansible.builtin.debug:
        var: ansible_facts
```
> **Ansible Facts Injected as Variables**
Before Ansible 2.5, facts were always injected as individual variables prefixed with the string ansible_ instead of being part of the ansible_facts variable. For example, the ansible_facts['distribution'] fact was called ansible_distribution.

| ansible_facts.\* name                                           | ansible_\* name                                        |
| --------------------------------------------------------------- | ------------------------------------------------------ |
| `ansible_facts['hostname']`                                     | `ansible_hostname`                                     |
| `ansible_facts['fqdn']`                                         | `ansible_fqdn`                                         |
| `ansible_facts['default_ipv4']['address']`                      | `ansible_default_ipv4['address']`                      |

#### Custom Facts

By default, the ansible.builtin.setup module loads custom facts from files and scripts in the etc/ansible/facts.d. File shoudl end with ".fact". The ansible.builtin.setup module stores custom facts in the ansible_facts['ansible_local'] variable.

```ini
# file name should end with .fact
[packages]
web_package = httpd
db_package = mariadb-server

[users]
user1 = joe
user2 = jane
```

#### Packages Facts

```yaml
- name: Insure package facts gathered
  ansible.builtin.package_facts:

- name: print package facts
  ansible.builtin.debug:
    var: ansible_facts.packages
```


# YAML

## Special characters

| Character           | Description                                  |
|---------------------|----------------------------------------------|
| ( \| ) vertical ber | to denote a new line characters              |
| ( > ) greater-than  | new line characters to be converted to spaces|

```yaml
include_newlines: |
  Example Company
  123 Main Street
  Atlanta, GA 30303
```

```yaml
fold_newlines: >
  This is an example
  of a long string,
  that will become
  a single sentence once folded.
```

## YAML Dictionaries

```yaml
name: svcrole
svcservice: httpd
svcport: 80
```

```yaml
{name: svcrole, svcservice: httpd, svcport: 80}
```

## YAML Lists

```yaml
hosts:
  - servera
  - serverb
  - serverc
```

```yaml
hosts: [servera, serverb, serverc]
```
