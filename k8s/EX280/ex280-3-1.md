
# Configure Identity Provider

## Command examples

```sh
# create a new htpasswd file
htpasswd -c -B -b ./htpasswd new_admin redhat # -c create; -B bcrypt; -b bath mode
# update httpasswd file
htpasswd -b ./htpasswd new_developer developer


# create secret from the htpasswd file
oc create secret generic localusers --from-file htpasswd=./htpasswd \
-n openshift-config

# export the existing OAuth resource to a file
oc get oauth cluster -o yaml > ./oauth.yml

# Update the ./oauth.yml file and re-apply
# oc edit oauth
oc replace -f ./oauth.yml
watch oc get all -n openshift-authentication

# Display list of current identities.
oc get identity

# Extract the file data from the secret (for update)
oc extract secret/localusers -n openshift-config --to . --confirm

# Update the secret
oc set data secret/localusers --from-file htpasswd=./htpasswd -n openshift-config

# assign the new_admin user the cluster-admin role
oc adm policy add-cluster-role-to-user cluster-admin new_admin

oc delete identity "myusers:manager"
oc delete user manager
oc get users
oc get identity
oc delete user --all
oc delete identity --all

```

## Definitions
User - entities that interact with the API server. The user resource represents an actor within the system.

Identity - resouce that keeps a record of successful authentication attempts from a specific user and identity provider. Any data about the source of the authentication is stored on the identity

Servie Account - In OpenShift, applications can communicate with the API independently when user credentials cannot be acquired. To preserve the integrity of the credentials for a regular user, credentials are not shared and service accounts are used instead. With service accounts, you can control API access without the need to borrow a regular user's credentials.

Group - represens a specific set of users.

Role - defines the API operations that a user has permissions to perform on specified resource types.

**User** and **Identity** resources are usually not created in advance. 

## Authenticatiog API Requests
The OpenShift API has two methods for authenticating requests:
* OAuth access tokens
* X.509 client certificates

### The Authentication Operator
The OpenShift provides the Authentication operator, which runs an OAuth server. 

The OAuth server provides OAuth access tokens to users when they attempt to authenticate to the API. 

An identity provider must be configured and available to the OAuth server. The OAuth server uses an identity provider to validate the identity of the requster. The server reconciles the user with the identity and creates the OAuth access token for the user. OpenShift automatically creates identity and user resources after a successful login

#### Identity Providers

**HTPasswd** - validates credentials against the file generated by *htpasswd* command

```yaml
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: my_htpasswd_provider # This provider name is prefixed to provider user names to form an identity name
    mappingMethod: claim # With the default claim value, you cannot log in with different identity providers.
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpasswd-secret # An existing secret that contains data that is generated by using the htpasswd command
```

**Keystone** - OpenStack Keystone v3 server

**LDAP** - LDAPv3

The OAuth custom resource must be updated with your chosen identity provider. You can define multiple identity providers, of the same or different kinds, on the same OAuth custom resource.


### Authenticating as a Cluster Administrator

Authenticate to a newly installed cluster

* `kubeconfig` file, embeds an X.509 client cerfificate
* `kubeadmin` virtual user.